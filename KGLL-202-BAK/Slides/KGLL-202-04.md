# Applying a Kong Licence

<!-- .slide: class="page-title" -->



## Kong Licence

In traditional deployment with no separate control plane, license must be deployed to each node running Kong Gateway.

There are multiple ways to configure a license file on a Kong Gateway node. These are defined below in the order in which they are checked by Kong:

1. If present, the contents of the environmental variable `KONG_LICENSE_DATA` is used
2. Kong will search in the default location `/etc/kong/license.json`
3. If present, the contents of the file defined by the environment variable `KONG_LICENSE_PATH` is used
4. Directly deploy a license using the `/licenses` Admin API endpoint 
   - e.g. `http -h POST localhost:8001/licenses \
  payload=@/path/to/license.json`



## Kong Licence

In hybrid deployments, applying the license to CP using method 4, will result in distribution of the license from CP to DP. Otherwise methods 1/2/3 should be used on each DP node. 

We will perform the following specific tasks:
1. Apply the license
2. Restart the Control Plane and and Review the License




## Task 1: Apply the license

For the purpose of this lab we will apply the licence using option 4 above, i.e. by using the Admin API endpoint. 

Run the following command:

```shell
http -h POST localhost:8001/licenses payload=@/etc/kong/license.json
```

<!-- There whould be 4 occurences, under the following services
- kong-migrations
- kong-migrations-up
- kong-cp
- kong-dp -->

<!-- ## Task 1: Apply the license

For the purpose of this lab we will apply the licence using option 2 above, i.e. by mounting the directory containing the licence in the docker container. The appropriate lines to mount the licence file already exists in `docker-compose.yaml`, but are commented out.

Open `~/docker-compose.yaml` either in a command line editor (e.g. vi or nano), or using the 'Editor' lab in the lab environment and uncomment the following lines under volumes (if using the lab editor then the full path is `/home/ubuntu/KGLL-202/docker-compose.yaml`).

```
    ...
    volumes:
    - /etc/kong/license.json:/etc/kong/license.json
    ...
```

There whould be 4 occurences, under the following services
- kong-migrations
- kong-migrations-up
- kong-cp
- kong-dp -->




## Task 2: Restart the Control Plane and and Review the License

No matter which option you used to apply the licence, you need to restart the Kong Gateway for the licence to be applied.

<!-- Before doing so, set the `KONG_LICENSE_DATA` environment variable (we'll need this set before we launch the Developer Portal a little later).

```shell
export KONG_LICENSE_DATA=$(cat /etc/kong/license.json)
```` -->

```shell
docker compose stop kong-cp
```
```
[+] Running 1/1
 ⠿ Container kong-cp  Stopped                                                                   6.6s
 ```

```shell
docker compose rm -f kong-cp
```
```
Going to remove kong-cp
[+] Running 1/0
 ⠿ Container kong-cp  Removed                                                                   0.0s
 ```




## Task 2: Restart the Control Plane and and Review the License


```shell
docker compose up -d kong-cp
```
```
[+] Running 4/4
 ⠿ Container postgres            Running          0.0s
 ⠿ Container kong-migrations     Started          0.5s
 ⠿ Container kong-migrations-up  Started          0.9s
 ⠿ Container kong-cp             Started          1.6s
 ```




## Task 2: Restart the Control Plane and and Review the License

You can verify the licence in the database

```shell
http GET localhost:8001/license/report
```
```
{
    "counters": [
        {
            "bucket": "2023-03",
            "request_count": 0
        }
    ],
    "db_version": "postgres 13.1",
    "kong_version": "3.2.2.0",
    "license_key": "0011K000022IA3HQAW_a1V1K0000099iyaUAA",
    "system_info": {
        "cores": 4,
        "hostname": "kong-cp",
        "uname": "Linux x86_64"
    },
    "workspaces_count": 1
}
```



## Licence Details

You can get further details on the deployed license from the license file itself:

```shell
cat /etc/kong/license.json | jq
```
# 06 - Kong Vitals


## Lab: Kong Vitals

cd
source scram.sh

cd
git clone https://github.com/kong-education/kong-gateway-operations.git
source ~/kong-gateway-operations/installation/scram.sh


## Task: Configure Service/Route/Consumer/Plugins

http POST kongcluster:8001/services \
  name=mockbin_service \
  url=http://mockbin:8080/request

### curl -sX POST kongcluster:8001/services \
       -d name=mockbin_service \
       -d url=http://mockbin:8080/request \
       | jq

http -f POST kongcluster:8001/services/mockbin_service/routes \
  name=mockbin_route \
  paths=/mockbin

### curl -sX POST kongcluster:8001/services/mockbin_service/routes \
      -d name=mockbin_route \
      -d paths=/mockbin \
      | jq

http -f POST kongcluster:8001/services/mockbin_service/plugins \
  name=rate-limiting \
  config.minute=16 \
  config.policy=local

### curl -sX POST kongcluster:8001/services/mockbin_service/plugins \
      -d name=rate-limiting \
      -d config.minute=16 \
      -d config.policy=local \
      | jq

http POST kongcluster:8001/services/mockbin_service/plugins name=key-auth
### curl -sX POST kongcluster:8001/services/mockbin_service/plugins \
      -d name=key-auth \
      | jq

http POST kongcluster:8001/consumers username=Jane
### curl -sX POST kongcluster:8001/consumers \
      -d username=Jane \
      | jq

http POST kongcluster:8001/consumers/Jane/key-auth key=JanePassword
### curl -sX POST kongcluster:8001/consumers/Jane/key-auth \
      -d key=JanePassword \
      | jq


## Task: Let's Create Some Traffic

for ((i=0;i<64;i++))
  do
    sleep 1
    http -h GET $KONG_PROXY_URI/mockbin/request?apikey=JanePassword > /dev/null 2>&1
  done &

### for ((i=0;i<64;i++))
      do
        sleep 1
        curl -IsX GET $KONG_PROXY_URI/mockbin/request?apikey=JanePassword > /dev/null 2>&1
      done &


## Task: Get Metrics from Vitals API

http GET kongcluster:8001/default/vitals/status_code_classes?interval=minutes | jq .stats.cluster
### curl -sX GET kongcluster:8001/default/vitals/status_code_classes?interval=minutes | jq .stats.cluster


## Task: Inspect Kong Vitals Configuration

grep KONG_VITALS docker-compose.yaml | sort -u


## Task: Inspect Prometheus/StatsD Configuration

cat /srv/shared/misc/prometheus.yaml
cat /srv/shared/misc/statsd.rules.yaml


## Task: Get to GUI for Prometheus

env | grep PROMETHEUS_URI


## Task: Configure Grafana

env | grep GRAFANA_URI


## Task: Let's Create Some Traffic

for ((i=0;i<256;i++))
  do
    sleep 1
    http -h GET $KONG_PROXY_URI/mockbin/request?apikey=JanePassword
  done

### for ((i=0;i<256;i++))
      do
        sleep 1
        curl -IsX GET $KONG_PROXY_URI/mockbin/request?apikey=JanePassword
      done
